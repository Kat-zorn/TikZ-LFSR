% TikZ-LFSR Â© 2025 by Luka Bijma is licensed under CC BY 4.0. A copy of this license can be found at https://creativecommons.org/licenses/by/4.0/.
% View this code on Github at https://github.com/Kat-zorn/TikZ-LFSR/.
% The author is not affiliated with the TikZ project, whose code is licensed under the GPLv2.

\NeedsTeXFormat{LaTeX2e}[2021]
\ProvidesPackage{tikz-lfsr}[package to make pretty LFSR diagrams in TikZ]

\RequirePackage{tikz}
\RequirePackage{xstring}
\RequirePackage{pgfkeys}

% Users may redefine this macro to 1 to make the package render additional debugging information when using the \ManyLFSR command.
\def\ManyLFSRDebug{0}

% Shift the character #1 by #2 - 1 places.
\newcommand{\LFSR@addletter}[2]{
  \char\number\numexpr\expandafter`#1 + #2 - 1
}

% Define the optional arguments for the LFSR and ManyLFSR commands.
% base name: Default `s'
%         The name of the values in the cells of the top index.
%         This will be incremented by one for each additional LFSR. 
%         This must be a single character when ManyLFSR is used.
%         With LFSR a multi-character string is allowed.
% zero subscript: Default 0
%         What to subscipt the name by for the 0-index.
%         A popular option is `j'.
% x base: Default 0
%         The x-position in the picture to draw the leftmost edge of the LFSR at.
%         Only has an effect on the internal \LFSR@Draw command.
% y base: Default 0
%         The y-position in the picture to draw the bottom of the LFSR at.
%         Only has an effect on the internal \LFSR@Draw command.
\pgfkeys{
    /lfsr/.is family, /lfsr,
    default/.style =
     {
       base name = s,
       zero subscript = 0,
       x base = 0,
       y base = 0,
     },
    base name/.estore in = \LfsrBaseName,
    zero subscript/.estore in = \LfsrZeroSubscript,
    x base/.estore in = \LfsrXBase,
    y base/.estore in = \LfsrYBase,
}

% Draw a single LFSR. Takes optional arguments as specified above.
% The manditory argument is binary number, starting with 1.
% Here, a one marks that a cell contributes to the final sum.
\newcommand\LFSR[2][]{
  % parse
  \pgfkeys{/lfsr, default, #1}  
  % Configure picture for bigger arrows
  \begin{tikzpicture}[line width=1pt, =>stealth]
    \LFSR@Draw[#1]{#2}
    % Draw outgoing arrow
    \pgfmathsetmacro{\yPlusHalf}{\LfsrYBase + 0.5}
    \pgfmathsetmacro{\XMinHalf }{\LfsrXBase - 0.5}
    
    \draw[->] (\LfsrXBase, \yPlusHalf) -- (\XMinHalf, \yPlusHalf);
  \end{tikzpicture}  
}

% Similar to the LFSR command, but its mandatory argument
% is a comma-separated list of such binary numbers.
\newcommand\ManyLFSR[2][]{
  % Parse arguments
  \pgfkeys{/lfsr, default, #1}
  % Only the first character of the base name will be used when drawing several LFSRs.
  \StrChar{\LfsrBaseName}{1}[\ManyLFSRBaseChar]
  % Configure picture for bigger arrows
  \begin{tikzpicture}[line width=1pt, =>stealth]
    % Draw the combining circle and outward arrow.
    \LFSR@DrawCircle{(-1, 0)}{1}
    \draw [->] (-1.5, 0) -- (-2.5, 0);
    % Compute how many LFSRs have been given.
    \pgfmathparse{dim(#2)}
    \pgfmathsetmacro{\ManyLFSRLength}{\pgfmathresult}
    % Draw each LFSR
    \foreach \ManyLFSRInputString [count=\ManyLFSRIndex] in {#2} {
        % Compute the name and position of this LFSR.
        \def\ManyLFSRLetter{\LFSR@addletter{\ManyLFSRBaseChar}{\ManyLFSRIndex}}
        \pgfmathsetmacro{\ManyLFSRHeight}{(\ManyLFSRIndex - (\ManyLFSRLength + 1) / 2) * -3 - 0.5}
        \pgfmathsetmacro{\ManyLFSRLineBaseHeight}{\ManyLFSRHeight + 0.5}
        \pgfmathsetmacro{\ManyLFSRRatio}{1-(\ManyLFSRIndex - 1)/(\ManyLFSRLength - 1)}
        \pgfmathsetmacro{\ManyLFSRCircleX}{-abs(\ManyLFSRRatio - 0.5) * 2 + 1}
        \pgfmathsetmacro{\ManyLFSRDrawX}{\ManyLFSRCircleX/2 - 1}
        \pgfmathsetmacro{\ManyLFSRCircleY}{sin(sign(\ManyLFSRRatio - 0.5) * acos(\ManyLFSRCircleX))}
        \pgfmathsetmacro{\ManyLFSRDrawY}{\ManyLFSRCircleY / 2}
        % Draw the LFSR at that position.
        \LFSR@Draw[#1, y base = \ManyLFSRHeight, base name = \ManyLFSRLetter]{\ManyLFSRInputString}

        % Draw the arrow between the LFSR to the final sum symbol.
        \pgfmathtruncatemacro{\ManyLFSRIntY}{round(\ManyLFSRCircleY * 10)}
        \if \ManyLFSRIntY 0
            % The arrow is almost flat. Don't bother giving it an angle.
            % This prevents misaligned arrowheads.
            \draw[->] (0, \ManyLFSRLineBaseHeight) -- (\ManyLFSRDrawX, \ManyLFSRDrawY);
            \def\ManyLFSRMode{direct}
        \else
            % Draw the arrow with an angle.
            \draw[->] (0, \ManyLFSRLineBaseHeight) -- (\ManyLFSRDrawX, \ManyLFSRLineBaseHeight) -- (\ManyLFSRDrawX, \ManyLFSRDrawY);
            \def\ManyLFSRMode{indirect}
        \fi
        % Print the extra debug text left of the diagram, if debug mode is enabled.
        \if \ManyLFSRDebug 1
            \node [align=left] at (-3, 
            \ManyLFSRLineBaseHeight) {
            Ratio: \ManyLFSRRatio, \\
            X: \ManyLFSRCircleX, \\
            Y: \ManyLFSRCircleY, \\
            Mode: \ManyLFSRMode, \\
            Global name: \ManyLFSRBaseChar, \\
            Name: \ManyLFSRLetter
            };
        \fi
    }
  \end{tikzpicture}  
}

% Draw a circle at #1 of diameter #2, with a + sign in the center.
\newcommand\LFSR@DrawCircle[2]{
    \node[
        draw,
        circle,
        fill=white,
        draw=black,
        minimum size=#2cm,
        inner sep=0,
    ] at #1 {\Large\bf +};
}

% Draw an LFSR into an existing tikzpicture.
% Same syntax as the LFSR command.
\newcommand\LFSR@Draw[2][]{
    % Parse arguments
    \pgfkeys{/lfsr, default, #1}
    \def\inputString{#2}
    
    % Compute the positions of several points
    \StrLen{\inputString}[\n]
    %% Used for the inital arrow
    \pgfmathsetmacro{\XPlusHalf}{\LfsrXBase + 0.5}
    \pgfmathsetmacro{\XPlusN}{\LfsrXBase + \n}
    \pgfmathsetmacro{\XPlusNOne}{\LfsrXBase + \n + 1}
    %% Used everywhere
    \pgfmathsetmacro{\yPlusHalf  }{\LfsrYBase + 0.5}
    \pgfmathsetmacro{\yPlusOne   }{\LfsrYBase + 1}
    \pgfmathsetmacro{\yPlusOneSix}{\LfsrYBase + 1.6}
    \pgfmathsetmacro{\yPlusTwo   }{\LfsrYBase + 2}

    
    % Require that the first character is 1
    \StrChar{\inputString}{1}[\firstChar]
    \IfStrEq{\firstChar}{0}{\PackageWarning{tikz-LFSR}{The most significant bit is not set, but will be treated as it.}}{}

    % Draw loop from s_0 to s_{n-1}
    \pgfmathtruncatemacro{\x}{\n + 1}
    \draw[->] (\XPlusHalf, \yPlusOne) -- (\XPlusHalf, \yPlusTwo) -- (\XPlusNOne, \yPlusTwo) -- (\XPlusNOne, \yPlusHalf) -- (\XPlusN, \yPlusHalf);

    % Draw each cell, circle, and arrow
    \foreach \i in {1,...,\n} {
        % Read the character
        \StrChar{\inputString}{\i}[\ch]
        \IfStrEq{\ch}{1}{
            \ifnum \i > 1
            {
                % Draw the circle and arrow, but not above the first cell.
                \pgfmathsetmacro{\xMidPoint  }{\LfsrXBase + \i - 0.5}
                \pgfmathsetmacro{\xRightEdge }{\LfsrXBase +\i - 0.9}
                \pgfmathsetmacro{\xLeftEdge  }{\LfsrXBase +\i - 1.1}
                % Draw upwards arrow
                \draw[->] (\xMidPoint, \yPlusOne) -- (\xMidPoint, \yPlusOneSix);
                % Draw circle
                \LFSR@DrawCircle{(\xMidPoint, \yPlusTwo)}{0.8}
                % Draw arrowhead pointing into circle from left side
                \draw[->] (\xLeftEdge, \yPlusTwo) -- (\xRightEdge, \yPlusTwo); 
            } \fi
        }{  % if \ch != 1
            % Check whether digit is at least 0
            \IfStrEq{\ch}{0}{  % No problem
            }{
            % Problem
            \PackageError{tikz-LFSR}{Unknown digit found. `\ch'}{Please only use 0 and 1.}
            }
        }
        % Prepare for drawing the box
        \pgfmathsetmacro{\x}{\LfsrXBase + \i-0.5}
        \def\subscript{{err}}
        \ifnum \i = 1
            \def\subscript{\LfsrZeroSubscript}
        \else
            \pgfmathtruncatemacro{\subscript}{\i-1}
        \fi
        % Draw the box with the computed text and position.
        \node[
        draw,
        rectangle,
        draw=black,
        minimum size=1cm,
        inner sep=0,
        ] at (\x, \yPlusHalf) {\Large$\LfsrBaseName_\subscript$};
    }
  % \end{tikzpicture}
}
